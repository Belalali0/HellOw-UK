<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HellOw UK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&family=Poppins:wght@900&display=swap');
        :root { --bg-main: #f8fafc; --bg-card: #ffffff; --text-main: #1e293b; --border: #e2e8f0; --accent: #ffd700; }
        .dark { --bg-main: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --border: #334155; --accent: #ffd700; }
        body { font-family: 'Noto Sans Arabic', 'Poppins', sans-serif; background-color: var(--bg-main); color: var(--text-main); transition: 0.3s; margin: 0; overflow-x: hidden; direction: rtl !important; text-align: right !important; }
        .mobile-shell { max-width: 480px; margin: 0 auto; min-height: 100vh; background: var(--bg-card); position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .nav-bottom { position: fixed; bottom: 0; max-width: 480px; width: 100%; background: var(--bg-card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; }
        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .active-page { display: block; }
        .active-nav { color: var(--accent) !important; }
        .input-field { width: 100%; padding: 12px; background: var(--bg-main); border: 1px solid var(--border); border-radius: 12px; outline: none; color: inherit; margin-bottom: 10px; text-align: right; }
        .custom-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: var(--bg-card); padding: 20px; border-radius: 20px; border: 2px solid #ff5555; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .like-btn.active { color: #ff5555 !important; }
        .notification-dot { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: red; border-radius: 50%; display: none; }
    </style>
</head>
<body class="light">

<div id="msgModal" class="hidden fixed inset-0 bg-black/70 z-[1000] flex items-center justify-center p-4">
    <div class="custom-alert">
        <i id="msgIcon" class="fas fa-exclamation-circle text-4xl mb-3 text-red-500"></i>
        <p id="msgText" class="font-bold text-sm leading-relaxed mb-5"></p>
        <button onclick="closeMsg()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold lang-nav" data-key="okBtn">OK</button>
    </div>
</div>

<div class="mobile-shell pb-24">
    <header class="sticky top-0 bg-[var(--bg-card)] border-b border-[var(--border)] p-4 flex justify-between items-center z-50">
        <div class="flex items-center gap-2 cursor-pointer" onclick="window.handleAdminTrigger()">
            <i class="fas fa-book-open text-2xl text-[var(--accent)]"></i>
            <div class="brand-text text-xl font-black italic">
                <span class="text-[#ff5555]">He</span><span class="text-slate-400">ll</span><span class="text-[#ffd700]">O</span><span class="text-slate-400">w</span> <span class="text-green-400">UK</span>
                <div id="lang-indicator" class="text-[9px] font-bold text-gray-400 uppercase tracking-[3px]">EN</div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="relative cursor-pointer" onclick="showPage('notif-page')">
                <i id="notif-bell" class="far fa-bell text-[#ffd700] text-xl"></i>
                <div id="notif-dot" class="notification-dot"></div>
            </div>
            <i id="header-heart" onclick="window.checkHeartStatus()" class="fas fa-heart-broken text-gray-400 text-xl cursor-pointer"></i>
            <i id="theme-icon" onclick="toggleTheme()" class="fas fa-moon text-xl cursor-pointer"></i>
            <select id="langSelect" onchange="changeLanguage(this.value)" class="bg-transparent font-bold text-xs outline-none">
                <option value="en">EN</option>
                <option value="ku">KU</option>
                <option value="ar">AR</option>
                <option value="fa">FA</option>
            </select>
        </div>
    </header>

    <div id="pages">
        <main id="home-page" class="page active-page"><div id="post-list" class="space-y-4"></div></main>
        <main id="info-page" class="page"><div id="info-list" class="space-y-4"></div></main>
        <main id="muslim-page" class="page"><div id="muslim-list" class="space-y-4"></div></main>
        <main id="org-page" class="page"><div id="org-list" class="space-y-4"></div></main>
        
        <main id="notif-page" class="page">
            <div class="flex justify-between items-center mb-6">
                <h2 class="font-bold lang-nav" data-key="notifTitle">Notifications</h2>
                <button onclick="window.toggleNotifStatus()" class="text-xs flex items-center gap-1 bg-gray-100 dark:bg-slate-800 px-3 py-1 rounded-full">
                    <span id="notif-status-text">ON</span>
                    <i id="notif-toggle-icon" class="fas fa-bell"></i>
                </button>
            </div>
            <div id="notif-list" class="space-y-4"></div>
        </main>

        <main id="fav-page" class="page">
            <h2 class="text-center font-bold mb-4 lang-nav" data-key="favTitle">Favorite Posts</h2>
            <div id="fav-list" class="space-y-4 text-center py-10 opacity-50 lang-nav" data-key="emptyFav">Nothing here yet</div>
        </main>

        <main id="account-page" class="page">
            <div id="auth-ui" class="space-y-4 text-center">
                <h2 class="text-xl font-bold lang-nav" data-key="acc">Account</h2>
                <input type="text" id="reg-user" placeholder="Username" class="input-field lang-placeholder" data-key="phUser">
                <input type="email" id="reg-email" placeholder="Email" class="input-field lang-placeholder" data-key="phEmail">
                <input type="password" id="reg-pass" placeholder="Password" class="input-field lang-placeholder" data-key="phPass">
                <div class="flex gap-2">
                    <button onclick="window.handleEmailAuth('login')" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold lang-nav" data-key="loginBtn">Login</button>
                    <button onclick="window.handleEmailAuth('register')" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold lang-nav" data-key="regBtn">Register</button>
                </div>
            </div>
            <div id="user-profile" class="hidden text-center space-y-4 py-10">
                <i class="fas fa-user-circle text-7xl text-blue-500"></i>
                <p id="user-display-name" class="text-lg font-bold"></p>
                <p id="user-role-badge" class="text-xs font-black text-blue-500 uppercase border border-blue-500 px-2 py-1 rounded inline-block"></p>
                <br>
                <button onclick="window.signOutUser()" class="text-red-500 font-bold border-b border-red-500 lang-nav" data-key="logout">Log Out</button>
            </div>
        </main>
    </div>

    <div id="adminModal" class="fixed inset-0 bg-black/80 hidden z-[500] p-4 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-[var(--bg-card)] w-full max-w-sm rounded-3xl p-6 overflow-y-auto max-h-[90vh]">
            <div class="flex border-b mb-4 font-bold overflow-x-auto whitespace-nowrap">
                <button onclick="switchTab('post')" id="tab-p-btn" class="flex-1 py-2 text-blue-600 border-b-2 border-blue-600 lang-nav" data-key="tabPost">Post</button>
                <button onclick="switchTab('notif')" id="tab-n-btn" class="flex-1 py-2 opacity-40 lang-nav" data-key="tabNotif">Notification</button>
                <button onclick="switchTab('dash')" id="tab-d-btn" class="flex-1 py-2 opacity-40 lang-nav" data-key="tabDash">Dashboard</button>
                <button onclick="closeAdmin()" class="px-2 text-red-500 font-black">X</button>
            </div>
            
            <div id="tab-post">
                <input type="text" id="p-title" placeholder="Title" class="input-field">
                <textarea id="p-text" placeholder="Content" class="input-field h-20"></textarea>
                <input type="text" id="p-external-link" placeholder="External Link (URL)" class="input-field">
                <div class="mb-3">
                    <label class="block text-[10px] font-bold mb-1 opacity-60">Upload Photo/Video:</label>
                    <input type="file" id="p-file" accept="image/*,video/*" class="text-xs mb-2">
                    <progress id="upload-progress" value="0" max="100" class="w-full h-1 hidden"></progress>
                </div>
                <div class="flex gap-2 mb-4 text-xs font-bold">
                    <select id="p-lang" class="flex-1 p-3 bg-[var(--bg-main)] rounded-xl border border-[var(--border)]"><option value="en">English</option><option value="ku" selected>Kurdî</option><option value="ar">عربي</option><option value="fa">فارسی</option></select>
                    <select id="p-cat" class="flex-1 p-3 bg-[var(--bg-main)] rounded-xl border border-[var(--border)]"><option value="home">News</option><option value="info">Info</option><option value="muslim">Muslim</option><option value="org">Org</option></select>
                </div>
                <button id="publish-btn" onclick="window.submitPost()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-green-600/20 lang-nav" data-key="publish">Publish</button>
            </div>

            <div id="tab-notif" class="hidden">
                <textarea id="n-text" placeholder="Notification Message..." class="input-field h-32"></textarea>
                <select id="n-lang" class="w-full p-3 bg-[var(--bg-main)] rounded-xl border border-[var(--border)] mb-4 font-bold">
                    <option value="en">English</option>
                    <option value="ku" selected>Kurdî</option>
                    <option value="ar">عربي</option>
                    <option value="fa">فارسی</option>
                </select>
                <button id="send-notif-btn" onclick="window.sendNotification()" class="w-full bg-yellow-500 text-white py-4 rounded-2xl font-bold shadow-lg">Send Alert</button>
            </div>

            <div id="tab-dash" class="hidden">
                <div class="grid grid-cols-2 gap-2 text-[10px] font-bold text-center mb-4">
                    <div class="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-lg text-blue-600"><span class="lang-nav" data-key="totalAcc">Accounts</span>: <span id="acc-count">0</span></div>
                    <div class="bg-green-100 dark:bg-green-900/30 p-2 rounded-lg text-green-600"><span class="lang-nav" data-key="online">Online</span>: <span id="online-count">0</span></div>
                </div>
                <input type="text" oninput="window.searchUser(this.value)" placeholder="Search..." class="input-field text-sm">
                <div id="user-list-admin" class="space-y-2 mt-2 max-h-64 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <nav class="nav-bottom">
        <button onclick="showPage('home-page', this)" class="nav-item active-nav flex flex-col items-center">
            <i class="fas fa-home"></i><span class="text-[9px] mt-1 font-bold lang-nav" data-key="news">News</span>
        </button>
        <button onclick="showPage('info-page', this)" class="nav-item text-gray-400 flex flex-col items-center">
            <i class="fas fa-info-circle"></i><span class="text-[9px] mt-1 font-bold lang-nav" data-key="info">Info</span>
        </button>
        <button onclick="showPage('muslim-page', this)" class="nav-item text-gray-400 flex flex-col items-center">
            <i class="fas fa-mosque"></i><span class="text-[9px] mt-1 font-bold lang-nav" data-key="muslim">Muslim</span>
        </button>
        <button onclick="showPage('org-page', this)" class="nav-item text-gray-400 flex flex-col items-center">
            <i class="fas fa-hands-helping"></i><span class="text-[9px] mt-1 font-bold lang-nav" data-key="org">Org</span>
        </button>
        <button onclick="showPage('account-page', this)" class="nav-item text-gray-400 flex flex-col items-center">
            <i class="fas fa-user-circle"></i><span class="text-[9px] mt-1 font-bold lang-nav" data-key="acc">Account</span>
        </button>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD-D5D-Frux74ptEWe62lge8AgKXwY6MJQ",
        authDomain: "hellowuk-72d77.firebaseapp.com",
        projectId: "hellowuk-72d77",
        storageBucket: "hellowuk-72d77.appspot.com",
        messagingSenderId: "1029264488576",
        appId: "1:1029264488576:web:d83e815da5ee6831fd4e65"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentLang = localStorage.getItem('userLang') || 'en';
    let currentUserData = null;
    let unsubscribePosts = null;
    let unsubscribeNotifs = null;
    window.allUsers = [];

    const langData = {
        en: { news: "News", info: "Info", muslim: "Muslim", org: "Org", acc: "Account", error: "Error, try again", heartMsg: "You broke my heart! If you want to fix it and make me happy, please create an account.", favTitle: "Favorites", emptyFav: "Nothing yet", phUser: "Username", phEmail: "Email", phPass: "Password", loginBtn: "Login", regBtn: "Register", okBtn: "OK", logout: "Log Out", tabPost: "Post", tabDash: "Dashboard", publish: "Publish", totalAcc: "Total Accounts", online: "Online", fillAll: "Fill all fields", tabNotif: "Alert", notifTitle: "Notifications" },
        ku: { news: "هەواڵ", info: "زانیاری", muslim: "مسوڵمان", org: "ڕێکخراو", acc: "ئەکاونت", error: "هەڵەیەک ڕوویدا", heartMsg: "تۆ دڵی منت شکاند، ئەگەر ئەتەوێت چاکی کەیتەوە و دڵخۆشم بکەیت ئەکاونت دروستبکە!", favTitle: "دڵخوازەکان", emptyFav: "هیچ لێرە نییە", phUser: "ناوی بەکارهێنەر", phEmail: "ئیمەیڵ", phPass: "وشەی تێپەڕ", loginBtn: "چوونەژوورەوە", regBtn: "تۆمارکردن", okBtn: "باشە", logout: "چوونە دەرەوە", tabPost: "پۆست", tabDash: "داشبۆرد", publish: "بڵاوکردنەوە", totalAcc: "ئەکاونتەکان", online: "ئۆنڵاین", fillAll: "خانەکان پڕبکەرەوە", tabNotif: "نۆتیفیکەیشن", notifTitle: "ئاگادارییەکان" },
        ar: { news: "أخبار", info: "معلومات", muslim: "مسلم", org: "منظمات", acc: "حساب", error: "خطأ، حاول مجدداً", heartMsg: "لقد كسرت قلبي! إذا كنت تريد إصلاحه وإسعادي، يرجى إنشاء حساب.", favTitle: "المفضلة", emptyFav: "لا يوجد شيء", phUser: "المستخدم", phEmail: "الايميل", phPass: "كلمة السر", loginBtn: "دخول", regBtn: "تسجيل", okBtn: "حسناً", logout: "خروج", tabPost: "نشر", tabDash: "لوحة التحكم", publish: "نشر", totalAcc: "الحسابات", online: "متصل", fillAll: "املأ الحقول", tabNotif: "إشعار", notifTitle: "الإشعارات" },
        fa: { news: "اخبار", info: "اطلاعات", muslim: "مسلمان", org: "سازمان", acc: "حساب", error: "خطا، دوباره تلاش کنید", heartMsg: "تو قلب مرا شکستی! اگر می‌خواهی آن را ترمیم کنی و مرا خوشحال کنی، لطفاً یک حساب کاربری بساز.", favTitle: "علاقه‌مندی‌ها", emptyFav: "چیزی نیست", phUser: "نام کاربری", phEmail: "ایمیل", phPass: "رمز عبور", loginBtn: "ورود", regBtn: "ثبت نام", okBtn: "باشه", logout: "خروج", tabPost: "پست", tabDash: "داشبورد", publish: "انتشار", totalAcc: "حساب‌ها", online: "آنلاین", fillAll: "فیلدها را پر کنید", tabNotif: "اعلان", notifTitle: "اعلان‌ها" }
    };

    window.showAlert = (text, icon = "fa-exclamation-circle") => {
        document.getElementById('msgText').innerText = text;
        document.getElementById('msgIcon').className = `fas ${icon} text-4xl mb-3 ${icon.includes('check') ? 'text-green-500' : 'text-red-500'}`;
        document.getElementById('msgModal').classList.remove('hidden');
    };
    window.closeMsg = () => document.getElementById('msgModal').classList.add('hidden');

    window.changeLanguage = (l) => {
        currentLang = l;
        localStorage.setItem('userLang', l);
        document.getElementById('lang-indicator').innerText = l.toUpperCase();
        document.getElementById('langSelect').value = l;
        document.querySelectorAll('.lang-nav').forEach(el => {
            if(langData[l][el.dataset.key]) el.innerText = langData[l][el.dataset.key];
        });
        document.querySelectorAll('.lang-placeholder').forEach(el => {
            if(langData[l][el.dataset.key]) el.placeholder = langData[l][el.dataset.key];
        });
        loadPosts();
        loadNotifications();
    };

    window.checkHeartStatus = () => {
        if (!auth.currentUser) {
            showAlert(langData[currentLang].heartMsg, "fa-heart-broken");
        } else {
            showPage('fav-page');
        }
    };

    onAuthStateChanged(auth, async (user) => {
        const heartIcon = document.getElementById('header-heart');
        if (user) {
            const userRef = doc(db, "users", user.email);
            const userDoc = await getDoc(userRef);
            if (userDoc.exists()) {
                currentUserData = userDoc.data();
            } else {
                currentUserData = { username: user.displayName || 'User', email: user.email, role: user.email === 'belalbelaluk@gmail.com' ? 'owner' : 'user', likes: [], notifEnabled: true };
                await setDoc(userRef, currentUserData);
            }
            await updateDoc(userRef, { lastSeen: Date.now() });
            document.getElementById('auth-ui').classList.add('hidden');
            document.getElementById('user-profile').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = currentUserData.username;
            document.getElementById('user-role-badge').innerText = currentUserData.role;
            heartIcon.classList.replace('fa-heart-broken', 'fa-heart');
            heartIcon.classList.replace('text-gray-400', 'text-red-500');
            updateNotifUI();
        } else {
            currentUserData = null;
            document.getElementById('auth-ui').classList.remove('hidden');
            document.getElementById('user-profile').classList.add('hidden');
            heartIcon.classList.replace('fa-heart', 'fa-heart-broken');
            heartIcon.classList.replace('text-red-500', 'text-gray-400');
        }
        loadPosts(); 
        loadNotifications();
    });

    window.toggleNotifStatus = async () => {
        if (!auth.currentUser) return showAlert(langData[currentLang].heartMsg);
        const newState = !currentUserData.notifEnabled;
        await updateDoc(doc(db, "users", auth.currentUser.email), { notifEnabled: newState });
        currentUserData.notifEnabled = newState;
        updateNotifUI();
        loadNotifications();
    };

    function updateNotifUI() {
        const bell = document.getElementById('notif-bell');
        const toggleIcon = document.getElementById('notif-toggle-icon');
        const statusText = document.getElementById('notif-status-text');
        
        if (currentUserData && currentUserData.notifEnabled) {
            bell.className = "fas fa-bell text-[#ffd700] text-xl";
            toggleIcon.className = "fas fa-bell text-green-500";
            statusText.innerText = "ON";
        } else {
            bell.className = "far fa-bell text-[#ffd700] text-xl opacity-50";
            toggleIcon.className = "far fa-bell-slash text-red-500";
            statusText.innerText = "OFF";
        }
    }

    window.handleEmailAuth = async (type) => {
        const email = document.getElementById('reg-email').value.trim().toLowerCase();
        const pass = document.getElementById('reg-pass').value;
        const name = document.getElementById('reg-user').value.trim();
        if(!email || !pass) return showAlert(langData[currentLang].fillAll);
        try {
            if (type === 'register') {
                if(!name) return showAlert(langData[currentLang].fillAll);
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                await updateProfile(res.user, { displayName: name });
                await setDoc(doc(db, "users", email), { username: name, email: email, role: email === 'belalbelaluk@gmail.com' ? 'owner' : 'user', likes: [], notifEnabled: true, createdAt: Date.now(), lastSeen: Date.now() });
            } else {
                await signInWithEmailAndPassword(auth, email, pass);
            }
        } catch (e) { showAlert(langData[currentLang].error); }
    };

    window.signOutUser = () => signOut(auth);

    window.handleAdminTrigger = () => {
        if (currentUserData && (currentUserData.role === 'owner' || currentUserData.role === 'admin')) {
            document.getElementById('adminModal').classList.remove('hidden');
        }
    };

    window.sendNotification = async () => {
        const text = document.getElementById('n-text').value;
        const lang = document.getElementById('n-lang').value;
        if (!text) return showAlert(langData[currentLang].fillAll);
        
        try {
            await addDoc(collection(db, "notifications"), {
                text, lang, time: Date.now(), author: auth.currentUser.email, likesCount: 0
            });
            document.getElementById('n-text').value = "";
            showAlert("Notification Sent!", "fa-check-circle");
        } catch (e) { showAlert(langData[currentLang].error); }
    };

    window.submitPost = async () => {
        if (!currentUserData || (currentUserData.role !== 'owner' && currentUserData.role !== 'admin')) return;
        const title = document.getElementById('p-title').value;
        const text = document.getElementById('p-text').value;
        const link = document.getElementById('p-external-link').value;
        const file = document.getElementById('p-file').files[0];
        const postLang = document.getElementById('p-lang').value;
        const postCat = document.getElementById('p-cat').value;
        const btn = document.getElementById('publish-btn');
        const progress = document.getElementById('upload-progress');
        
        if(!title || !text) return showAlert(langData[currentLang].fillAll);
        btn.disabled = true; btn.innerText = "Processing...";
        
        let mediaUrl = ""; 
        let mediaType = "";
        
        try {
            if (file) {
                progress.classList.remove('hidden');
                const fileRef = ref(storage, `uploads/${Date.now()}_${file.name}`);
                const uploadTask = uploadBytesResumable(fileRef, file);
                
                await new Promise((resolve, reject) => {
                    uploadTask.on('state_changed', 
                        (snap) => { progress.value = (snap.bytesTransferred / snap.totalBytes) * 100; },
                        (err) => reject(err),
                        async () => { 
                            mediaUrl = await getDownloadURL(uploadTask.snapshot.ref); 
                            mediaType = file.type.startsWith('video') ? 'video' : 'image'; 
                            resolve(); 
                        }
                    );
                });
            }
            
            await addDoc(collection(db, "posts"), {
                title, 
                text, 
                media: mediaUrl, 
                mediaType, 
                externalLink: link,
                lang: postLang,
                category: postCat,
                time: Date.now(), 
                author: auth.currentUser.email, 
                likesCount: 0
            });
            
            document.getElementById('adminModal').classList.add('hidden');
            showAlert("Success", "fa-check-circle");
            
            // Reset fields
            document.getElementById('p-title').value = ""; 
            document.getElementById('p-text').value = "";
            document.getElementById('p-file').value = ""; 
            document.getElementById('p-external-link').value = "";
            progress.classList.add('hidden');
            
        } catch (e) { 
            console.error(e);
            showAlert(langData[currentLang].error); 
        } finally { 
            btn.disabled = false; 
            btn.innerText = langData[currentLang].publish; 
        }
    };

    window.deleteItem = async (id, type) => {
        if (!currentUserData || (currentUserData.role !== 'owner' && currentUserData.role !== 'admin')) return;
        if (!confirm("Are you sure?")) return;
        try {
            await deleteDoc(doc(db, type === 'post' ? "posts" : "notifications", id));
            showAlert("Deleted!", "fa-check-circle");
        } catch (e) { showAlert(langData[currentLang].error); }
    };

    window.toggleLike = async (postId, type = 'post') => {
        if(!auth.currentUser) return showAlert(langData[currentLang].heartMsg, "fa-heart-broken");
        const userRef = doc(db, "users", auth.currentUser.email);
        const col = type === 'post' ? "posts" : "notifications";
        const itemRef = doc(db, col, postId);
        const isLiked = currentUserData.likes && currentUserData.likes.includes(postId);
        try {
            if(isLiked) {
                await updateDoc(userRef, { likes: arrayRemove(postId) });
                await updateDoc(itemRef, { likesCount: increment(-1) });
                currentUserData.likes = currentUserData.likes.filter(id => id !== postId);
            } else {
                await updateDoc(userRef, { likes: arrayUnion(postId) });
                await updateDoc(itemRef, { likesCount: increment(1) });
                if(!currentUserData.likes) currentUserData.likes = [];
                currentUserData.likes.push(postId);
            }
        } catch(e) { console.error(e); }
    };

    function loadPosts() {
        if(unsubscribePosts) unsubscribePosts();
        
        const q = query(
            collection(db, "posts"), 
            where("lang", "==", currentLang), 
            orderBy("time", "desc")
        );

        unsubscribePosts = onSnapshot(q, (snap) => {
            const containers = { home: 'post-list', info: 'info-list', muslim: 'muslim-list', org: 'org-list' };
            Object.values(containers).forEach(id => { 
                const el = document.getElementById(id);
                if(el) el.innerHTML = ""; 
            });
            
            const favList = document.getElementById('fav-list');
            if(favList) favList.innerHTML = "";
            let hasFavs = false;
            const isAdmin = currentUserData && (currentUserData.role === 'owner' || currentUserData.role === 'admin');

            snap.forEach(d => {
                const p = d.data();
                const isLiked = currentUserData?.likes?.includes(d.id);
                let mediaHtml = "";
                if(p.media) {
                    if(p.mediaType === 'video') mediaHtml = `<video src="${p.media}" controls class="w-full h-auto rounded-xl mb-3 max-h-60 bg-black"></video>`;
                    else mediaHtml = `<img src="${p.media}" class="w-full h-44 object-cover rounded-xl mb-3">`;
                }
                const postHtml = `<div class="bg-[var(--bg-card)] rounded-2xl border border-[var(--border)] p-4 shadow-sm mb-4 relative">
                    ${isAdmin ? `<button onclick="window.deleteItem('${d.id}', 'post')" class="absolute top-2 left-2 text-red-500 bg-red-100 p-2 rounded-lg text-xs font-bold z-10"><i class="fas fa-trash"></i></button>` : ''}
                    <div onclick="${p.externalLink ? `window.open('${p.externalLink}', '_blank')` : ''}" class="${p.externalLink ? 'cursor-pointer' : ''}">
                        ${mediaHtml}
                        <div class="flex justify-between items-start">
                             <button onclick="event.stopPropagation(); window.toggleLike('${d.id}', 'post')" class="like-btn ${isLiked ? 'active' : 'text-gray-300'}"><i class="fas fa-heart"></i> <span class="text-[10px]">${p.likesCount || 0}</span></button>
                             <div class="text-right flex-1 mr-3">
                                <h3 class="font-bold text-md">${p.title}</h3>
                                <p class="text-xs opacity-70 mt-1">${p.text}</p>
                                ${p.externalLink ? `<span class="text-[10px] text-blue-500 underline mt-2 block">Link <i class="fas fa-external-link-alt"></i></span>` : ''}
                             </div>
                        </div>
                    </div>
                </div>`;
                
                if(containers[p.category] && document.getElementById(containers[p.category])) {
                    document.getElementById(containers[p.category]).innerHTML += postHtml;
                }
                
                if(isLiked && favList) { favList.innerHTML += postHtml; hasFavs = true; }
            });
            
            if(favList) {
                favList.classList.toggle('opacity-50', !hasFavs);
                if(!hasFavs) favList.innerHTML = `<div class="py-10 text-center lang-nav" data-key="emptyFav">${langData[currentLang].emptyFav}</div>`;
            }
        }, (error) => {
            console.error("Error loading posts:", error);
        });
    }

    function loadNotifications() {
        if(unsubscribeNotifs) unsubscribeNotifs();
        
        const list = document.getElementById('notif-list');
        const dot = document.getElementById('notif-dot');
        
        if (currentUserData && !currentUserData.notifEnabled) {
            if(list) list.innerHTML = "<p class='text-center opacity-50 py-10'>Notifications OFF</p>";
            if(dot) dot.style.display = "none";
            return;
        }

        const q = query(
            collection(db, "notifications"), 
            where("lang", "==", currentLang), 
            orderBy("time", "desc")
        );

        unsubscribeNotifs = onSnapshot(q, (snap) => {
            if(list) list.innerHTML = "";
            let hasUnread = false;
            const isAdmin = currentUserData && (currentUserData.role === 'owner' || currentUserData.role === 'admin');
            
            snap.forEach(d => {
                const n = d.data();
                const isLiked = currentUserData?.likes?.includes(d.id);
                hasUnread = true;
                if(list) {
                    list.innerHTML += `<div class="bg-yellow-50 dark:bg-yellow-900/10 border-r-4 border-yellow-500 p-4 rounded-xl shadow-sm relative mb-3">
                        ${isAdmin ? `<button onclick="window.deleteItem('${d.id}', 'notif')" class="absolute top-2 left-2 text-red-500 bg-red-100 p-1 rounded-md text-[10px] font-bold"><i class="fas fa-trash"></i></button>` : ''}
                        <div class="flex justify-between items-start">
                             <button onclick="window.toggleLike('${d.id}', 'notif')" class="like-btn ${isLiked ? 'active' : 'text-gray-300'}">
                                <i class="fas fa-heart"></i> <span class="text-[10px]">${n.likesCount || 0}</span>
                             </button>
                             <p class="text-sm font-bold flex-1 text-right mr-3">${n.text}</p>
                             <i class="fas fa-bullhorn text-yellow-600 text-xs"></i>
                        </div>
                    </div>`;
                }
            });
            if(dot) dot.style.display = (hasUnread && snap.size > 0) ? "block" : "none";
        }, (error) => {
            console.error("Error loading notifications:", error);
        });
    }

    onSnapshot(collection(db, "users"), (snap) => {
        window.allUsers = []; let onlineCount = 0;
        snap.forEach(d => {
            const userData = d.data(); window.allUsers.push(userData);
            if (userData.lastSeen && (Date.now() - userData.lastSeen) < 300000) onlineCount++;
        });
        const accCountEl = document.getElementById('acc-count');
        const onlineCountEl = document.getElementById('online-count');
        if(accCountEl) accCountEl.innerText = snap.size;
        if(onlineCountEl) onlineCountEl.innerText = onlineCount;
        renderUserList(window.allUsers);
    });

    window.renderUserList = (users) => {
        const list = document.getElementById('user-list-admin');
        if(!list) return; list.innerHTML = "";
        const isOwner = auth.currentUser?.email === 'belalbelaluk@gmail.com';
        users.forEach(u => {
            list.innerHTML += `<div class="flex flex-col bg-[var(--bg-main)] p-3 rounded-xl mb-2 border border-[var(--border)]">
                <div class="flex justify-between items-start">
                    <div class="text-right"><div class="font-bold text-xs">${u.username || 'User'}</div><div class="text-[10px] opacity-60">${u.email}</div></div>
                    <span class="text-[9px] font-black px-2 py-0.5 rounded bg-blue-100 text-blue-600 uppercase">${u.role || 'user'}</span>
                </div>
                ${(isOwner && u.email !== auth.currentUser.email) ? `<div class="flex gap-1 mt-2">
                    <button onclick="window.updateRole('${u.email}', 'admin')" class="flex-1 bg-blue-600 text-white text-[9px] py-1.5 rounded-lg font-bold">Admin</button>
                    <button onclick="window.updateRole('${u.email}', 'user')" class="flex-1 bg-gray-400 text-white text-[9px] py-1.5 rounded-lg font-bold">User</button>
                </div>` : ''}
            </div>`;
        });
    };

    window.updateRole = async (email, role) => {
        try { await updateDoc(doc(db, "users", email), { role: role }); showAlert("Updated!"); }
        catch(e) { showAlert(langData[currentLang].error); }
    };

    window.searchUser = (val) => {
        const f = window.allUsers.filter(u => u.email?.toLowerCase().includes(val.toLowerCase()) || u.username?.toLowerCase().includes(val.toLowerCase()));
        renderUserList(f);
    };

    window.changeLanguage(currentLang);
</script>

<script>
    function showPage(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active-page');
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.replace('active-nav', 'text-gray-400'));
        if(btn && btn.classList.contains('nav-item')) btn.classList.replace('text-gray-400', 'active-nav');
        
        if(id === 'notif-page') {
            const dot = document.getElementById('notif-dot');
            if(dot) dot.style.display = "none";
        }
    }
    
    function closeAdmin() { document.getElementById('adminModal').classList.add('hidden'); }
    
    function switchTab(t) {
        document.getElementById('tab-post').classList.toggle('hidden', t !== 'post');
        document.getElementById('tab-dash').classList.toggle('hidden', t !== 'dash');
        document.getElementById('tab-notif').classList.toggle('hidden', t !== 'notif');
        const tabs = { post: 'tab-p-btn', dash: 'tab-d-btn', notif: 'tab-n-btn' };
        Object.keys(tabs).forEach(k => {
            const el = document.getElementById(tabs[k]);
            if(el) el.className = k === t ? "flex-1 py-2 text-blue-600 border-b-2 border-blue-600" : "flex-1 py-2 opacity-40";
        });
    }
    
    function toggleTheme() {
        document.body.classList.toggle('dark');
        const icon = document.getElementById('theme-icon');
        if(icon) icon.className = document.body.classList.contains('dark') ? "fas fa-sun text-yellow-300 text-xl cursor-pointer" : "fas fa-moon text-gray-900 text-xl cursor-pointer";
    }
</script>
</body>
</html>
